#pragma once

#include "Status_M.h"


template<typename Callee_t>
struct StatusNotify_M : private Status_M // 1 byte
{
 
	enum eNotifyStatus
	{
		eNotifyStarted		= Status_M::eStarted	<<3,	// 0b00010000
		eNotifySuspended	= Status_M::eSuspended<<3,	// 0b00100000
		eNotifyLocked		= Status_M::eLocked	<<3,	// 0b01000000
		eNotifyDeleted		= 0b10000000,				// 0b10000000
		eNotifyMask			= ~Status_M::eStatusMask
    };
	
	bool isStatus(uint8_t s){ return ((mStatus&s) == s); }
		
	void setStatus(uint8_t s, bool state)
	{
		if(isStatus(Status_M::eLocked) && s!=Status_M::eLocked){ return;}

		uint8_t prevNotifStatus = (mStatus&Status_M::eStatusMask)<<3;
		
		state ? mStatus|=s : mStatus&=~s;

		// is the new status notifiable
		uint8_t newNotifStatus = ((s&Status_M::eStatusMask)<<3)&(mStatus&eNotifyMask);
		
		if(newNotifStatus)// status notifiable: notify callee
		{
			Callee_t::notifyStatusChange(prevNotifStatus, newNotifStatus);
		}
	}
	
	void setStatus(Status_M::eStatus s, bool state)
	{
		setStatus(static_cast<uint8_t>(s), state);
	}
	

	template<typename T>
	void init(T *t)	{ mStatus = 0; }
	template<typename T>
	bool isExeReady(T *t) const { return !(mStatus&Status::eSuspended) ;}
	template<typename T>
	bool isDelReady(T *t) const { return !(mStatus&Status::eLocked);}
	template<typename T>
	void makePreExe(T *t)
	{  
		setStatus(Status_M::eRunning, true); 
	}
	template<typename T>
	void makePostExe(T *t)
	{
		setStatus(Status_M::eRunning, false); 
		setStatus(Status_M::eStarted, true);
	}
	template<typename T>
	void makePreDel(T *t)
	{
		if( isStatus(eNotifyDeleted) )
		{
			Callee_t::notifyStatusChange(mStatus, eNotifyDeleted);
		}
		mStatus = 0;
	}
	
};


